name: ğŸ“Š Production Monitoring

on:
  schedule:
    # Run every 15 minutes
    - cron: '*/15 * * * *'
  workflow_dispatch:
    inputs:
      check_type:
        description: 'Type of monitoring check'
        required: true
        default: 'health'
        type: choice
        options:
          - health
          - performance
          - full

env:
  PRODUCTION_URL: https://fairytaleswithspice.vercel.app
  STAGING_URL: https://fairytaleswithspice-git-main.vercel.app

jobs:
  # ================================================================
  # HEALTH MONITORING
  # ================================================================
  health-check:
    name: ğŸ¥ Health Check Monitoring
    runs-on: ubuntu-latest
    timeout-minutes: 10
    outputs:
      health-status: ${{ steps.health.outputs.health-status }}
      response-time: ${{ steps.health.outputs.response-time }}
      
    steps:
      - name: ğŸ¥ Production health check
        id: health
        run: |
          echo "ğŸ¥ Checking production health..."
          
          HEALTH_URL="${{ env.PRODUCTION_URL }}/api/health"
          START_TIME=$(date +%s%N)
          
          # Perform health check with timeout
          if RESPONSE=$(curl -f -s --max-time 10 "$HEALTH_URL" 2>&1); then
            END_TIME=$(date +%s%N)
            RESPONSE_TIME=$((($END_TIME - $START_TIME) / 1000000))
            
            echo "âœ… Health check successful"
            echo "â±ï¸ Response time: ${RESPONSE_TIME}ms"
            echo "ğŸ“‹ Response: $RESPONSE"
            
            # Validate response structure
            if echo "$RESPONSE" | grep -q "healthy"; then
              echo "health-status=healthy" >> $GITHUB_OUTPUT
              echo "response-time=$RESPONSE_TIME" >> $GITHUB_OUTPUT
              
              # Check service status
              if echo "$RESPONSE" | grep -q "services"; then
                echo "ğŸ”§ Services status detected in response"
              fi
            else
              echo "âš ï¸ Health endpoint responded but status unclear"
              echo "health-status=unknown" >> $GITHUB_OUTPUT
              echo "response-time=$RESPONSE_TIME" >> $GITHUB_OUTPUT
            fi
          else
            echo "âŒ Health check failed"
            echo "ğŸ” Error details: $RESPONSE"
            echo "health-status=unhealthy" >> $GITHUB_OUTPUT
            echo "response-time=timeout" >> $GITHUB_OUTPUT
            exit 1
          fi
          
      - name: ğŸŒ Frontend availability check
        run: |
          echo "ğŸŒ Checking frontend availability..."
          
          FRONTEND_URL="${{ env.PRODUCTION_URL }}"
          
          if curl -f -s --max-time 10 "$FRONTEND_URL" > /dev/null; then
            echo "âœ… Frontend is accessible"
          else
            echo "âŒ Frontend is not accessible"
            exit 1
          fi
          
      - name: ğŸ”— API endpoints availability
        run: |
          echo "ğŸ”— Checking critical API endpoints..."
          
          BASE_URL="${{ env.PRODUCTION_URL }}/api"
          
          # Test health endpoint (already done above)
          echo "âœ… Health endpoint: Already verified"
          
          # Test story generation endpoint (POST - just check it responds to invalid requests properly)
          if curl -f -s --max-time 10 -X POST "$BASE_URL/story/generate" \
             -H "Content-Type: application/json" \
             -d '{}' | grep -q "success.*false"; then
            echo "âœ… Story generation endpoint responding correctly to invalid requests"
          else
            echo "âš ï¸ Story generation endpoint may have issues"
          fi
          
          # Test emotions info endpoint
          if curl -f -s --max-time 10 "$BASE_URL/emotions/info" > /dev/null; then
            echo "âœ… Emotions info endpoint accessible"
          else
            echo "âš ï¸ Emotions info endpoint may have issues"
          fi

  # ================================================================
  # PERFORMANCE MONITORING
  # ================================================================
  performance-check:
    name: âš¡ Performance Monitoring
    runs-on: ubuntu-latest
    timeout-minutes: 15
    if: ${{ github.event.inputs.check_type == 'performance' || github.event.inputs.check_type == 'full' || github.event_name == 'schedule' }}
    
    steps:
      - name: ğŸ“¦ Install performance tools
        run: |
          npm install -g lighthouse
          
      - name: âš¡ Run performance audit
        run: |
          echo "âš¡ Running performance audit..."
          
          FRONTEND_URL="${{ env.PRODUCTION_URL }}"
          
          # Run lightweight Lighthouse audit
          lighthouse "$FRONTEND_URL" \
            --only-categories=performance \
            --chrome-flags="--headless --no-sandbox --disable-dev-shm-usage" \
            --output json \
            --output-path lighthouse-performance.json \
            --quiet || echo "âš ï¸ Lighthouse audit completed with warnings"
          
          # Extract key metrics
          if [ -f "lighthouse-performance.json" ]; then
            # Parse performance score (requires jq)
            if command -v jq >/dev/null 2>&1; then
              PERF_SCORE=$(jq '.categories.performance.score * 100' lighthouse-performance.json 2>/dev/null || echo "unknown")
              FCP=$(jq '.audits["first-contentful-paint"].numericValue' lighthouse-performance.json 2>/dev/null || echo "unknown")
              LCP=$(jq '.audits["largest-contentful-paint"].numericValue' lighthouse-performance.json 2>/dev/null || echo "unknown")
              
              echo "ğŸ“Š Performance Score: ${PERF_SCORE}%"
              echo "ğŸ¨ First Contentful Paint: ${FCP}ms"
              echo "ğŸ–¼ï¸ Largest Contentful Paint: ${LCP}ms"
              
              # Performance thresholds
              if (( $(echo "$PERF_SCORE >= 90" | bc -l 2>/dev/null || echo 0) )); then
                echo "âœ… Performance score is excellent"
              elif (( $(echo "$PERF_SCORE >= 70" | bc -l 2>/dev/null || echo 0) )); then
                echo "âš ï¸ Performance score needs improvement"
              else
                echo "âŒ Performance score is poor"
                exit 1
              fi
            else
              echo "ğŸ“Š Performance audit completed (jq not available for detailed metrics)"
            fi
          fi
          
      - name: ğŸ“Š Upload performance report
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: performance-monitoring-report
          path: lighthouse-performance.json
          retention-days: 7

  # ================================================================
  # API FUNCTIONALITY MONITORING
  # ================================================================
  api-functionality-check:
    name: ğŸ”§ API Functionality Monitoring
    runs-on: ubuntu-latest
    timeout-minutes: 10
    if: ${{ github.event.inputs.check_type == 'full' || (github.event_name == 'schedule' && github.event.schedule == '0 */6 * * *') }}
    
    steps:
      - name: ğŸ“¥ Checkout code (for test utilities)
        uses: actions/checkout@v4
        
      - name: ğŸ“¦ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20.x'
          
      - name: ğŸ”§ Install test dependencies
        run: |
          cd tests
          npm ci --ignore-scripts
          
      - name: ğŸ§ª Run production API tests
        run: |
          cd tests
          npm run test:integration
        env:
          API_BASE_URL: ${{ env.PRODUCTION_URL }}/api
          TEST_TIMEOUT: 15000
          
      - name: ğŸ“Š Upload API test results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: api-functionality-results
          path: tests/coverage/
          retention-days: 7

  # ================================================================
  # UPTIME TRACKING
  # ================================================================
  uptime-tracking:
    name: ğŸ“ˆ Uptime Tracking
    runs-on: ubuntu-latest
    timeout-minutes: 5
    needs: [health-check]
    if: always()
    
    steps:
      - name: ğŸ“ˆ Calculate uptime metrics
        run: |
          echo "ğŸ“ˆ Calculating uptime metrics..."
          
          HEALTH_STATUS="${{ needs.health-check.outputs.health-status }}"
          CURRENT_TIME=$(date -u +"%Y-%m-%d %H:%M:%S UTC")
          
          echo "ğŸ• Check Time: $CURRENT_TIME"
          echo "ğŸ¥ Health Status: $HEALTH_STATUS"
          echo "â±ï¸ Response Time: ${{ needs.health-check.outputs.response-time }}ms"
          
          # Log status for tracking (in a real scenario, this would go to a monitoring system)
          if [ "$HEALTH_STATUS" = "healthy" ]; then
            echo "âœ… System is operational"
            echo "STATUS=UP" >> uptime.log
          else
            echo "âŒ System is experiencing issues"
            echo "STATUS=DOWN" >> uptime.log
          fi
          
          echo "$(date -u +%s),$HEALTH_STATUS,${{ needs.health-check.outputs.response-time }}" >> metrics.csv
          
      - name: ğŸ“Š Upload uptime data
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: uptime-tracking-data
          path: |
            uptime.log
            metrics.csv
          retention-days: 30

  # ================================================================
  # MONITORING SUMMARY & ALERTS
  # ================================================================
  monitoring-summary:
    name: ğŸ“‹ Monitoring Summary
    runs-on: ubuntu-latest
    needs: [health-check, performance-check, api-functionality-check, uptime-tracking]
    if: always()
    
    steps:
      - name: ğŸ“‹ Generate monitoring summary
        run: |
          echo "=== ğŸ“Š PRODUCTION MONITORING SUMMARY ==="
          echo ""
          echo "ğŸ• Monitoring Time: $(date -u +"%Y-%m-%d %H:%M:%S UTC")"
          echo ""
          echo "ğŸ“Š Check Results:"
          echo "  Health Check: ${{ needs.health-check.result }}"
          echo "  Performance Check: ${{ needs.performance-check.result }}"
          echo "  API Functionality: ${{ needs.api-functionality-check.result }}"
          echo "  Uptime Tracking: ${{ needs.uptime-tracking.result }}"
          echo ""
          echo "ğŸ¥ Health Details:"
          echo "  Status: ${{ needs.health-check.outputs.health-status }}"
          echo "  Response Time: ${{ needs.health-check.outputs.response-time }}ms"
          echo ""
          
          # Determine alert level
          ALERT_LEVEL="INFO"
          
          if [[ "${{ needs.health-check.result }}" == "failure" ]]; then
            ALERT_LEVEL="CRITICAL"
            echo "ğŸš¨ CRITICAL ALERT: Production health check failed!"
          elif [[ "${{ needs.performance-check.result }}" == "failure" ]]; then
            ALERT_LEVEL="WARNING"
            echo "âš ï¸ WARNING: Performance issues detected"
          elif [[ "${{ needs.api-functionality-check.result }}" == "failure" ]]; then
            ALERT_LEVEL="WARNING"
            echo "âš ï¸ WARNING: API functionality issues detected"
          else
            echo "âœ… All monitoring checks passed"
          fi
          
          echo "ğŸš¨ Alert Level: $ALERT_LEVEL"
          
          # In a real implementation, this would trigger alerts to Slack, email, etc.
          if [ "$ALERT_LEVEL" = "CRITICAL" ]; then
            echo "ğŸš¨ Would trigger immediate alerts to on-call team"
          elif [ "$ALERT_LEVEL" = "WARNING" ]; then
            echo "âš ï¸ Would trigger warning notifications"
          fi
          
      - name: ğŸ”” Status notification
        run: |
          echo "ğŸ”” Monitoring cycle completed"
          echo "ğŸ“… Next check: In 15 minutes (for health) or as scheduled"
          echo "ğŸ“Š Detailed reports available in job artifacts"