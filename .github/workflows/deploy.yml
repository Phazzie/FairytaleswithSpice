name: üöÄ Deployment Pipeline

on:
  push:
    branches: [main]
  workflow_dispatch:
    inputs:
      environment:
        description: 'Target environment'
        required: true
        default: 'staging'
        type: choice
        options:
          - staging
          - production
      skip_tests:
        description: 'Skip test validation'
        required: false
        default: false
        type: boolean

env:
  NODE_VERSION: '20.x'
  VERCEL_ORG_ID: ${{ secrets.VERCEL_ORG_ID }}
  VERCEL_PROJECT_ID: ${{ secrets.VERCEL_PROJECT_ID }}

jobs:
  # ================================================================
  # PRE-DEPLOYMENT VALIDATION
  # ================================================================
  pre-deployment-checks:
    name: üîç Pre-deployment Validation
    runs-on: ubuntu-latest
    timeout-minutes: 5
    outputs:
      should-deploy: ${{ steps.validation.outputs.should-deploy }}
      target-env: ${{ steps.validation.outputs.target-env }}
      
    steps:
      - name: üì• Checkout code
        uses: actions/checkout@v4
        
      - name: üîç Validate deployment conditions
        id: validation
        run: |
          # Determine target environment
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            TARGET_ENV="${{ github.event.inputs.environment }}"
            SKIP_TESTS="${{ github.event.inputs.skip_tests }}"
          else
            TARGET_ENV="staging"
            SKIP_TESTS="false"
          fi
          
          echo "target-env=$TARGET_ENV" >> $GITHUB_OUTPUT
          
          # Check if we should proceed with deployment
          if [ "$SKIP_TESTS" = "true" ]; then
            echo "‚ö†Ô∏è Deployment validation skipped by user request"
            echo "should-deploy=true" >> $GITHUB_OUTPUT
          else
            echo "‚úÖ Full validation required"
            echo "should-deploy=false" >> $GITHUB_OUTPUT
          fi
          
          echo "üéØ Target Environment: $TARGET_ENV"
          echo "üß™ Skip Tests: $SKIP_TESTS"

  # ================================================================
  # TRIGGER CI VALIDATION (if needed)
  # ================================================================
  run-ci-validation:
    name: üß™ CI Validation
    if: needs.pre-deployment-checks.outputs.should-deploy == 'false'
    needs: pre-deployment-checks
    uses: ./.github/workflows/ci.yml

  # ================================================================
  # STAGING DEPLOYMENT
  # ================================================================
  deploy-staging:
    name: üöÄ Deploy to Staging
    runs-on: ubuntu-latest
    timeout-minutes: 10
    needs: [pre-deployment-checks]
    if: |
      always() &&
      (needs.pre-deployment-checks.outputs.should-deploy == 'true' ||
       needs.run-ci-validation.result == 'success') &&
      (needs.pre-deployment-checks.outputs.target-env == 'staging' || 
       github.ref == 'refs/heads/main')
    environment:
      name: staging
      url: ${{ steps.deploy.outputs.preview-url }}
      
    steps:
      - name: üì• Checkout code
        uses: actions/checkout@v4
        
      - name: üì¶ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          
      - name: üì¶ Install Vercel CLI
        run: npm install --global vercel@latest
        
      - name: üîß Pull Vercel Environment Information
        run: vercel pull --yes --environment=preview --token=${{ secrets.VERCEL_TOKEN }}
        
      - name: üèóÔ∏è Build Project Artifacts
        run: vercel build --token=${{ secrets.VERCEL_TOKEN }}
        
      - name: üöÄ Deploy to Staging (Preview)
        id: deploy
        run: |
          PREVIEW_URL=$(vercel deploy --prebuilt --token=${{ secrets.VERCEL_TOKEN }})
          echo "preview-url=$PREVIEW_URL" >> $GITHUB_OUTPUT
          echo "üåê Staging URL: $PREVIEW_URL"
          
      - name: üìù Update deployment status
        run: |
          echo "‚úÖ Staging deployment completed successfully"
          echo "üåê Preview URL: ${{ steps.deploy.outputs.preview-url }}"

  # ================================================================
  # SMOKE TESTS
  # ================================================================
  smoke-tests:
    name: üí® Smoke Tests
    runs-on: ubuntu-latest
    timeout-minutes: 10
    needs: [deploy-staging]
    if: always() && needs.deploy-staging.result == 'success'
    
    steps:
      - name: üì• Checkout code
        uses: actions/checkout@v4
        
      - name: üì¶ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          
      - name: üîß Install test dependencies
        run: |
          cd tests
          npm ci --ignore-scripts
          
      - name: üí® Run smoke tests
        run: |
          cd tests
          npm run test:integration
        env:
          API_BASE_URL: ${{ needs.deploy-staging.outputs.preview-url }}/api
          TEST_TIMEOUT: 30000
          
      - name: üè• Health check
        run: |
          HEALTH_URL="${{ needs.deploy-staging.outputs.preview-url }}/api/health"
          echo "üè• Checking health endpoint: $HEALTH_URL"
          
          # Wait for deployment to be ready
          for i in {1..10}; do
            if curl -f -s "$HEALTH_URL" > /dev/null; then
              echo "‚úÖ Health check passed"
              break
            else
              echo "‚è≥ Waiting for deployment... (attempt $i/10)"
              sleep 10
            fi
          done
          
          # Final health check
          RESPONSE=$(curl -s "$HEALTH_URL" || echo "FAILED")
          if echo "$RESPONSE" | grep -q "healthy"; then
            echo "‚úÖ Smoke tests passed - Application is healthy"
          else
            echo "‚ùå Smoke tests failed - Health check failed"
            echo "Response: $RESPONSE"
            exit 1
          fi

  # ================================================================
  # PRODUCTION DEPLOYMENT
  # ================================================================
  deploy-production:
    name: üåü Deploy to Production
    runs-on: ubuntu-latest
    timeout-minutes: 15
    needs: [pre-deployment-checks, deploy-staging, smoke-tests]
    if: |
      always() &&
      needs.smoke-tests.result == 'success' &&
      (needs.pre-deployment-checks.outputs.target-env == 'production' ||
       (github.ref == 'refs/heads/main' && github.event_name == 'push'))
    environment:
      name: production
      url: https://fairytaleswithspice.vercel.app
      
    steps:
      - name: üì• Checkout code
        uses: actions/checkout@v4
        
      - name: üì¶ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          
      - name: üì¶ Install Vercel CLI
        run: npm install --global vercel@latest
        
      - name: üîß Pull Vercel Environment Information
        run: vercel pull --yes --environment=production --token=${{ secrets.VERCEL_TOKEN }}
        
      - name: üèóÔ∏è Build Project Artifacts
        run: vercel build --prod --token=${{ secrets.VERCEL_TOKEN }}
        
      - name: üåü Deploy to Production
        id: deploy
        run: |
          PRODUCTION_URL=$(vercel deploy --prebuilt --prod --token=${{ secrets.VERCEL_TOKEN }})
          echo "production-url=$PRODUCTION_URL" >> $GITHUB_OUTPUT
          echo "üåü Production URL: $PRODUCTION_URL"
          
      - name: üìù Update deployment status
        run: |
          echo "üåü Production deployment completed successfully"
          echo "üåê Production URL: https://fairytaleswithspice.vercel.app"

  # ================================================================
  # POST-DEPLOYMENT MONITORING
  # ================================================================
  post-deployment-monitoring:
    name: üìä Post-deployment Monitoring
    runs-on: ubuntu-latest
    timeout-minutes: 10
    needs: [deploy-production]
    if: always() && needs.deploy-production.result == 'success'
    
    steps:
      - name: üì• Checkout code
        uses: actions/checkout@v4
        
      - name: üè• Production health checks
        run: |
          PROD_URL="https://fairytaleswithspice.vercel.app"
          HEALTH_URL="$PROD_URL/api/health"
          
          echo "üè• Running post-deployment health checks..."
          echo "üåê Production URL: $PROD_URL"
          echo "üè• Health endpoint: $HEALTH_URL"
          
          # Wait for deployment to propagate
          sleep 30
          
          # Comprehensive health checks
          for i in {1..5}; do
            echo "üîç Health check attempt $i/5"
            
            # Basic health check
            if curl -f -s "$HEALTH_URL" -o health_response.json; then
              echo "‚úÖ Health endpoint responsive"
              
              # Validate health response
              if grep -q "healthy" health_response.json; then
                echo "‚úÖ Application reports healthy status"
                
                # Check service status
                if grep -q "services" health_response.json; then
                  echo "‚úÖ Services configuration detected"
                fi
                
                break
              else
                echo "‚ö†Ô∏è Health endpoint responded but status unclear"
              fi
            else
              echo "‚ùå Health check failed (attempt $i/5)"
              if [ $i -eq 5 ]; then
                echo "‚ùå All health checks failed"
                exit 1
              fi
              sleep 15
            fi
          done
          
          echo "‚úÖ Post-deployment monitoring completed successfully"
          
      - name: üìä Performance baseline check
        run: |
          PROD_URL="https://fairytaleswithspice.vercel.app"
          
          echo "‚ö° Running performance baseline checks..."
          
          # Simple response time check
          START_TIME=$(date +%s%N)
          curl -f -s "$PROD_URL" > /dev/null
          END_TIME=$(date +%s%N)
          
          RESPONSE_TIME=$((($END_TIME - $START_TIME) / 1000000))
          echo "‚ö° Homepage response time: ${RESPONSE_TIME}ms"
          
          if [ $RESPONSE_TIME -lt 5000 ]; then
            echo "‚úÖ Response time within acceptable range"
          else
            echo "‚ö†Ô∏è Response time above 5 seconds - consider optimization"
          fi

  # ================================================================
  # DEPLOYMENT STATUS SUMMARY
  # ================================================================
  deployment-status:
    name: üìã Deployment Status Summary
    runs-on: ubuntu-latest
    needs: [
      pre-deployment-checks,
      deploy-staging,
      smoke-tests,
      deploy-production,
      post-deployment-monitoring
    ]
    if: always()
    
    steps:
      - name: üìã Generate deployment summary
        run: |
          echo "=== üöÄ DEPLOYMENT PIPELINE SUMMARY ==="
          echo ""
          echo "üéØ Target Environment: ${{ needs.pre-deployment-checks.outputs.target-env }}"
          echo ""
          echo "üìä Job Results:"
          echo "  Pre-deployment Checks: ${{ needs.pre-deployment-checks.result }}"
          echo "  Staging Deployment: ${{ needs.deploy-staging.result }}"
          echo "  Smoke Tests: ${{ needs.smoke-tests.result }}"
          echo "  Production Deployment: ${{ needs.deploy-production.result }}"
          echo "  Post-deployment Monitoring: ${{ needs.post-deployment-monitoring.result }}"
          echo ""
          
          # Determine overall status
          if [[ "${{ needs.deploy-production.result }}" == "success" &&
                "${{ needs.post-deployment-monitoring.result }}" == "success" ]]; then
            echo "üåü DEPLOYMENT SUCCESSFUL - Production is live!"
            echo "üåê Production URL: https://fairytaleswithspice.vercel.app"
          elif [[ "${{ needs.deploy-staging.result }}" == "success" &&
                  "${{ needs.smoke-tests.result }}" == "success" ]]; then
            echo "üöÄ STAGING DEPLOYMENT SUCCESSFUL"
          elif [[ "${{ needs.deploy-staging.result }}" == "failure" ||
                  "${{ needs.smoke-tests.result }}" == "failure" ]]; then
            echo "‚ùå DEPLOYMENT FAILED - Check logs for details"
            exit 1
          else
            echo "‚ö†Ô∏è DEPLOYMENT PARTIALLY COMPLETED"
          fi