name: ğŸ”’ Security & Code Quality

on:
  schedule:
    # Run security scans daily at 3 AM UTC
    - cron: '0 3 * * *'
  push:
    branches: [main, develop]
    paths:
      - '**/*.ts'
      - '**/*.js'
      - '**/*.json'
      - '**/package*.json'
  pull_request:
    branches: [main, develop]
    paths:
      - '**/*.ts'
      - '**/*.js'
      - '**/*.json'
      - '**/package*.json'
  workflow_dispatch:

env:
  NODE_VERSION: '20.x'

jobs:
  # ================================================================
  # CODE QUALITY ANALYSIS
  # ================================================================
  code-quality-analysis:
    name: ğŸ“Š Advanced Code Quality Analysis
    runs-on: ubuntu-latest
    timeout-minutes: 15
    
    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Fetch full history for SonarCloud analysis
          
      - name: ğŸ“¦ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          
      - name: ğŸ”§ Install dependencies
        run: |
          # Install all project dependencies
          cd story-generator && npm ci --ignore-scripts && cd ..
          cd backend && npm ci --ignore-scripts && cd ..
          cd api && npm ci --ignore-scripts && cd ..
          
      - name: ğŸ“Š ESLint Analysis
        run: |
          echo "ğŸ“Š Running ESLint analysis..."
          
          # Frontend ESLint
          cd story-generator
          npx eslint src/ --ext .ts,.html --format json --output-file ../eslint-frontend.json || true
          cd ..
          
          # Backend ESLint (if configured)
          if [ -f "backend/.eslintrc*" ]; then
            cd backend
            npx eslint src/ --ext .ts --format json --output-file ../eslint-backend.json || true
            cd ..
          fi
          
      - name: ğŸ¨ Prettier Format Check
        run: |
          echo "ğŸ¨ Checking code formatting..."
          
          # Frontend formatting
          cd story-generator
          npx prettier --check src/ --list-different > ../prettier-frontend.txt || true
          cd ..
          
      - name: ğŸ” TypeScript Strict Mode Analysis
        run: |
          echo "ğŸ” Running TypeScript strict analysis..."
          
          # Frontend TypeScript
          cd story-generator
          npx tsc --noEmit --strict > ../typescript-frontend.log 2>&1 || true
          cd ..
          
          # Backend TypeScript
          cd backend
          npx tsc --noEmit --strict > ../typescript-backend.log 2>&1 || true
          cd ..
          
          # API TypeScript
          cd api
          npx tsc --noEmit --strict > ../typescript-api.log 2>&1 || true
          cd ..
          
      - name: ğŸ“Š Upload code quality reports
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: code-quality-reports
          path: |
            eslint-*.json
            prettier-*.txt
            typescript-*.log
          retention-days: 30

  # ================================================================
  # SECURITY SCANNING
  # ================================================================
  security-scanning:
    name: ğŸ”’ Advanced Security Scanning
    runs-on: ubuntu-latest
    timeout-minutes: 20
    
    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4
        
      - name: ğŸ“¦ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          
      - name: ğŸ”’ CodeQL Analysis
        uses: github/codeql-action/init@v3
        with:
          languages: javascript,typescript
          config-file: ./.github/codeql/codeql-config.yml
          
      - name: ğŸ”§ Install dependencies for CodeQL
        run: |
          cd story-generator && npm ci --ignore-scripts && cd ..
          cd backend && npm ci --ignore-scripts && cd ..
          cd api && npm ci --ignore-scripts && cd ..
          
      - name: ğŸ”’ Perform CodeQL Analysis
        uses: github/codeql-action/analyze@v3
        with:
          category: "/language:javascript"
          
      - name: ğŸ” Secret Scanning
        run: |
          echo "ğŸ” Running secret scanning..."
          
          # Basic secret pattern scanning
          echo "ğŸ” Scanning for potential secrets..."
          
          # Check for API keys, passwords, tokens
          SECRET_PATTERNS=(
            "api[_-]?key.*['\"][a-zA-Z0-9]{20,}['\"]"
            "password.*['\"][^'\"]{8,}['\"]"
            "secret.*['\"][a-zA-Z0-9]{20,}['\"]"
            "token.*['\"][a-zA-Z0-9]{20,}['\"]"
            "AKIA[0-9A-Z]{16}"  # AWS Access Key
            "sk_live_[0-9a-zA-Z]{24}"  # Stripe Live Key
          )
          
          for pattern in "${SECRET_PATTERNS[@]}"; do
            if grep -r -E "$pattern" . --exclude-dir=node_modules --exclude-dir=.git --exclude="*.log" --exclude="*.json" | grep -v ".github/workflows"; then
              echo "âš ï¸ Potential secret found matching pattern: $pattern"
            fi
          done
          
          echo "âœ… Secret scanning completed"
          
      - name: ğŸ›¡ï¸ Dependency Vulnerability Scan
        run: |
          echo "ğŸ›¡ï¸ Running comprehensive vulnerability scan..."
          
          # Use npm audit for all packages
          scan_package() {
            local dir=$1
            local name=$2
            
            if [ -f "$dir/package.json" ]; then
              echo "ğŸ›¡ï¸ Scanning $name in $dir..."
              cd "$dir"
              
              # Generate detailed audit report
              npm audit --audit-level low --json > "../security-audit-${name}.json" 2>&1 || true
              
              # Check for high/critical vulnerabilities
              if npm audit --audit-level high >/dev/null 2>&1; then
                echo "âœ… No high/critical vulnerabilities in $name"
              else
                echo "âš ï¸ High/critical vulnerabilities found in $name"
              fi
              
              cd ..
            fi
          }
          
          scan_package "story-generator" "frontend"
          scan_package "backend" "backend"
          scan_package "api" "api"
          scan_package "tests" "integration-tests"
          
      - name: ğŸ“Š Upload security reports
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: security-scan-reports
          path: security-audit-*.json
          retention-days: 90

  # ================================================================
  # ACCESSIBILITY TESTING
  # ================================================================
  accessibility-testing:
    name: â™¿ Accessibility Testing
    runs-on: ubuntu-latest
    timeout-minutes: 15
    
    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4
        
      - name: ğŸ“¦ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          
      - name: ğŸ”§ Install dependencies
        run: |
          cd story-generator
          npm ci --ignore-scripts
          
      - name: ğŸ—ï¸ Build application
        run: |
          cd story-generator
          npm run build
          
      - name: ğŸ“¦ Install accessibility tools
        run: |
          npm install -g @axe-core/cli
          npm install -g lighthouse
          
      - name: â™¿ Run accessibility tests
        run: |
          echo "â™¿ Running accessibility tests..."
          
          # Start a simple server for the built app
          cd story-generator/dist/story-generator/browser
          python3 -m http.server 8080 &
          SERVER_PID=$!
          
          # Wait for server to start
          sleep 5
          
          # Run axe-core accessibility tests
          axe http://localhost:8080 --save accessibility-report.json || true
          
          # Run Lighthouse accessibility audit
          lighthouse http://localhost:8080 \
            --only-categories=accessibility \
            --chrome-flags="--headless --no-sandbox --disable-dev-shm-usage" \
            --output json \
            --output-path ../../../lighthouse-accessibility.json || true
          
          # Stop server
          kill $SERVER_PID || true
          
          cd ../../../
          
          echo "âœ… Accessibility testing completed"
          
      - name: ğŸ“Š Upload accessibility reports
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: accessibility-reports
          path: |
            story-generator/dist/story-generator/browser/accessibility-report.json
            lighthouse-accessibility.json
          retention-days: 30

  # ================================================================
  # PERFORMANCE TESTING
  # ================================================================
  performance-testing:
    name: âš¡ Performance Testing
    runs-on: ubuntu-latest
    timeout-minutes: 20
    
    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4
        
      - name: ğŸ“¦ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          
      - name: ğŸ”§ Install dependencies
        run: |
          cd story-generator
          npm ci --ignore-scripts
          
      - name: ğŸ—ï¸ Build application
        run: |
          cd story-generator
          npm run build
          
      - name: ğŸ“¦ Install performance tools
        run: |
          npm install -g lighthouse
          npm install -g @lhci/cli
          
      - name: âš¡ Run performance tests
        run: |
          echo "âš¡ Running performance tests..."
          
          # Start a simple server
          cd story-generator/dist/story-generator/browser
          python3 -m http.server 8080 &
          SERVER_PID=$!
          
          # Wait for server to start
          sleep 5
          
          # Run comprehensive Lighthouse audit
          lighthouse http://localhost:8080 \
            --chrome-flags="--headless --no-sandbox --disable-dev-shm-usage" \
            --output json \
            --output html \
            --output-path ../../../lighthouse-report || true
          
          # Stop server
          kill $SERVER_PID || true
          
          cd ../../../
          
          echo "âœ… Performance testing completed"
          
      - name: ğŸ“Š Upload performance reports
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: performance-reports
          path: |
            lighthouse-report.json
            lighthouse-report.html
          retention-days: 30

  # ================================================================
  # SECURITY & QUALITY SUMMARY
  # ================================================================
  security-quality-summary:
    name: ğŸ“‹ Security & Quality Summary
    runs-on: ubuntu-latest
    needs: [
      code-quality-analysis,
      security-scanning,
      accessibility-testing,
      performance-testing
    ]
    if: always()
    
    steps:
      - name: ğŸ“‹ Generate comprehensive summary
        run: |
          echo "=== ğŸ”’ SECURITY & CODE QUALITY SUMMARY ==="
          echo ""
          echo "ğŸ“Š Analysis Results:"
          echo "  Code Quality Analysis: ${{ needs.code-quality-analysis.result }}"
          echo "  Security Scanning: ${{ needs.security-scanning.result }}"
          echo "  Accessibility Testing: ${{ needs.accessibility-testing.result }}"
          echo "  Performance Testing: ${{ needs.performance-testing.result }}"
          echo ""
          
          # Check for critical issues
          CRITICAL_ISSUES=false
          
          if [[ "${{ needs.security-scanning.result }}" == "failure" ]]; then
            echo "ğŸš¨ CRITICAL: Security scanning failed"
            CRITICAL_ISSUES=true
          fi
          
          if [[ "${{ needs.code-quality-analysis.result }}" == "failure" ]]; then
            echo "âš ï¸ WARNING: Code quality issues detected"
          fi
          
          if [[ "${{ needs.accessibility-testing.result }}" == "failure" ]]; then
            echo "â™¿ WARNING: Accessibility issues detected"
          fi
          
          if [[ "${{ needs.performance-testing.result }}" == "failure" ]]; then
            echo "âš¡ WARNING: Performance issues detected"
          fi
          
          echo ""
          if [ "$CRITICAL_ISSUES" = "true" ]; then
            echo "ğŸš¨ ACTION REQUIRED: Critical security issues detected!"
            exit 1
          else
            echo "âœ… Security and quality checks completed"
            echo "ğŸ“Š Review detailed reports in job artifacts"
          fi