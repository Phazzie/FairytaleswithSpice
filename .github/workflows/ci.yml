name: ğŸš€ Comprehensive CI Pipeline

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main, develop]
  workflow_dispatch:

env:
  NODE_VERSION: '20.x'
  CACHE_PREFIX: 'v1'

jobs:
  # ================================================================
  # CODE QUALITY & SECURITY SCANNING
  # ================================================================
  code-quality:
    name: ğŸ“‹ Code Quality & Type Checking
    runs-on: ubuntu-latest
    timeout-minutes: 10
    
    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4
        
      - name: ğŸ“¦ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          
      - name: ğŸ”§ Install root dependencies
        run: npm ci --ignore-scripts
        
      - name: ğŸ”§ Install frontend dependencies
        run: |
          cd story-generator
          npm ci --ignore-scripts
          
      - name: ğŸ”§ Install backend dependencies
        run: |
          cd backend
          npm ci --ignore-scripts
          
      - name: ğŸ”§ Install API test dependencies
        run: |
          cd api
          npm ci --ignore-scripts
          
      - name: âœ¨ Lint frontend code
        run: |
          cd story-generator
          npx ng lint || echo "Frontend linting completed with warnings"
          
      - name: âœ¨ Check frontend formatting
        run: |
          cd story-generator
          npx prettier --check src/ || echo "Frontend formatting check completed"
          
      - name: ğŸ” TypeScript compilation check - Frontend
        run: |
          cd story-generator
          npx tsc --noEmit
          
      - name: ğŸ” TypeScript compilation check - Backend
        run: |
          cd backend
          npx tsc --noEmit
          
      - name: ğŸ” TypeScript compilation check - API
        run: |
          cd api
          npx tsc --noEmit

  security-scan:
    name: ğŸ›¡ï¸ Security & Vulnerability Scanning
    runs-on: ubuntu-latest
    timeout-minutes: 15
    
    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4
        
      - name: ğŸ“¦ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          
      - name: ğŸ” Run npm audit - Root
        run: |
          npm audit --audit-level moderate || true
          npm audit --audit-level high --json > audit-root.json || true
          
      - name: ğŸ” Run npm audit - Frontend
        run: |
          cd story-generator
          npm ci --ignore-scripts
          npm audit --audit-level moderate || true
          npm audit --audit-level high --json > ../audit-frontend.json || true
          
      - name: ğŸ” Run npm audit - Backend
        run: |
          cd backend
          npm ci --ignore-scripts
          npm audit --audit-level moderate || true
          npm audit --audit-level high --json > ../audit-backend.json || true
          
      - name: ğŸ” Run npm audit - API
        run: |
          cd api
          npm ci --ignore-scripts
          npm audit --audit-level moderate || true
          npm audit --audit-level high --json > ../audit-api.json || true
          
      - name: ğŸ“Š Upload audit reports
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: security-audit-reports
          path: audit-*.json
          retention-days: 30

  # ================================================================
  # FRONTEND TESTING
  # ================================================================
  test-frontend:
    name: ğŸ¨ Frontend Testing (Angular)
    runs-on: ubuntu-latest
    timeout-minutes: 20
    
    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4
        
      - name: ğŸ“¦ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          
      - name: ğŸ”§ Install dependencies
        run: |
          cd story-generator
          npm ci --ignore-scripts
          
      - name: ğŸ§ª Run unit tests
        run: |
          cd story-generator
          npm test -- --watch=false --browsers=ChromeHeadless --code-coverage
          
      - name: ğŸ“Š Upload frontend coverage
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: frontend-coverage
          path: story-generator/coverage/
          retention-days: 30
          
      - name: ğŸ—ï¸ Build frontend
        run: |
          cd story-generator
          npm run build --if-present
          
      - name: ğŸ“Š Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: frontend-build
          path: story-generator/dist/
          retention-days: 7

  # ================================================================
  # BACKEND TESTING
  # ================================================================
  test-backend:
    name: âš™ï¸ Backend Testing (Node.js)
    runs-on: ubuntu-latest
    timeout-minutes: 15
    
    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4
        
      - name: ğŸ“¦ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          
      - name: ğŸ”§ Install dependencies
        run: |
          cd backend
          npm ci --ignore-scripts
          
      - name: ğŸ§ª Run backend tests
        run: |
          cd backend
          npm run test:coverage
          
      - name: ğŸ“Š Upload backend coverage
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: backend-coverage
          path: backend/coverage/
          retention-days: 30
          
      - name: ğŸ—ï¸ Build backend
        run: |
          cd backend
          npm run build

  # ================================================================
  # API TESTING
  # ================================================================
  test-api:
    name: ğŸŒ API Testing (Serverless Functions)
    runs-on: ubuntu-latest
    timeout-minutes: 15
    
    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4
        
      - name: ğŸ“¦ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          
      - name: ğŸ”§ Install dependencies
        run: |
          cd api
          npm ci --ignore-scripts
          
      - name: ğŸ§ª Run API tests
        run: |
          cd api
          npm run test:ci
          
      - name: ğŸ“Š Upload API coverage
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: api-coverage
          path: api/coverage/
          retention-days: 30

  # ================================================================
  # INTEGRATION TESTING
  # ================================================================
  test-integration:
    name: ğŸ”— Integration Testing
    runs-on: ubuntu-latest
    timeout-minutes: 20
    needs: [test-frontend, test-backend, test-api]
    
    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4
        
      - name: ğŸ“¦ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          
      - name: ğŸ”§ Install integration test dependencies
        run: |
          cd tests
          npm ci --ignore-scripts
          
      - name: ğŸ§ª Run integration tests
        run: |
          cd tests
          npm run test:integration
        env:
          API_BASE_URL: http://localhost:3000/api
          
      - name: ğŸ“Š Upload integration test results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: integration-test-results
          path: tests/coverage/
          retention-days: 30

  # ================================================================
  # BUILD VALIDATION
  # ================================================================
  build-validation:
    name: ğŸ—ï¸ Production Build Validation
    runs-on: ubuntu-latest
    timeout-minutes: 15
    needs: [code-quality, security-scan]
    
    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4
        
      - name: ğŸ“¦ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          
      - name: ğŸ”§ Install all dependencies
        run: |
          # Install root dependencies
          npm ci --ignore-scripts
          
          # Install frontend dependencies
          cd story-generator
          npm ci --ignore-scripts
          cd ..
          
          # Install backend dependencies
          cd backend
          npm ci --ignore-scripts
          cd ..
          
      - name: ğŸ—ï¸ Build frontend for production
        run: |
          cd story-generator
          npm run build
          
      - name: ğŸ—ï¸ Build backend for production
        run: |
          cd backend
          npm run build
          
      - name: âœ… Validate build outputs
        run: |
          # Check frontend build
          if [ ! -d "story-generator/dist" ]; then
            echo "âŒ Frontend build failed - no dist directory"
            exit 1
          fi
          
          # Check backend build
          if [ ! -d "backend/dist" ]; then
            echo "âŒ Backend build failed - no dist directory"
            exit 1
          fi
          
          echo "âœ… All builds completed successfully"
          
      - name: ğŸ“Š Upload production builds
        uses: actions/upload-artifact@v4
        with:
          name: production-builds
          path: |
            story-generator/dist/
            backend/dist/
          retention-days: 30

  # ================================================================
  # FINAL STATUS CHECK
  # ================================================================
  ci-status:
    name: âœ… CI Pipeline Status
    runs-on: ubuntu-latest
    needs: [
      code-quality,
      security-scan, 
      test-frontend,
      test-backend,
      test-api,
      test-integration,
      build-validation
    ]
    if: always()
    
    steps:
      - name: ğŸ“‹ Check pipeline status
        run: |
          echo "=== CI Pipeline Results ==="
          echo "Code Quality: ${{ needs.code-quality.result }}"
          echo "Security Scan: ${{ needs.security-scan.result }}"
          echo "Frontend Tests: ${{ needs.test-frontend.result }}"
          echo "Backend Tests: ${{ needs.test-backend.result }}"
          echo "API Tests: ${{ needs.test-api.result }}"
          echo "Integration Tests: ${{ needs.test-integration.result }}"
          echo "Build Validation: ${{ needs.build-validation.result }}"
          
          # Check if any required job failed
          if [[ "${{ needs.code-quality.result }}" == "failure" ||
                "${{ needs.test-frontend.result }}" == "failure" ||
                "${{ needs.test-backend.result }}" == "failure" ||
                "${{ needs.test-api.result }}" == "failure" ||
                "${{ needs.build-validation.result }}" == "failure" ]]; then
            echo "âŒ CI Pipeline FAILED - Required jobs failed"
            exit 1
          elif [[ "${{ needs.security-scan.result }}" == "failure" ||
                  "${{ needs.test-integration.result }}" == "failure" ]]; then
            echo "âš ï¸ CI Pipeline completed with WARNINGS"
            exit 0
          else
            echo "âœ… CI Pipeline PASSED - All checks successful"
            exit 0
          fi