<div class="story-generator">
  <!-- Notification Component -->
  <app-notifications></app-notifications>
  
  <header class="header">
    <h1>üßö‚Äç‚ôÄÔ∏è Fairytales with Spice</h1>
    <p>Create spicy fantasy stories with your favorite creatures</p>
  </header>

  <div class="main-content">
    <!-- Story Generation Form -->
    <div class="form-section">
      <h2>Story Configuration</h2>

      <!-- Creature Selector -->
      <div class="form-group" [class.has-error]="hasFieldError('creature')">
        <label for="creature-group">Choose Your Creature:</label>
        <div class="radio-group" role="radiogroup" aria-labelledby="creature-group" id="creature-group">
          <label class="radio-option" *ngFor="let creature of creatures; trackBy: trackByCreature">
            <input 
              type="radio" 
              name="creature" 
              [value]="creature.value" 
              [(ngModel)]="selectedCreature"
              [attr.aria-describedby]="hasFieldError('creature') ? 'creature-error' : null"
              [attr.aria-invalid]="hasFieldError('creature')">
            <span class="radio-label">{{creature.label}}</span>
          </label>
        </div>
        <div *ngIf="hasFieldError('creature')" class="field-error" id="creature-error" role="alert">
          <span *ngFor="let error of getFieldErrors('creature')" class="error-message">{{error}}</span>
        </div>
      </div>

      <!-- Theme Checkboxes -->
      <div class="form-group" [class.has-error]="hasFieldError('themes')">
        <label for="themes-group">Story Themes:</label>
        <div class="checkbox-group" role="group" aria-labelledby="themes-group" id="themes-group">
          <label class="checkbox-option" *ngFor="let theme of themes; trackBy: trackByTheme">
            <input 
              type="checkbox" 
              [value]="theme.value" 
              [(ngModel)]="selectedThemes"
              [attr.aria-describedby]="hasFieldError('themes') ? 'themes-error' : null"
              [attr.aria-invalid]="hasFieldError('themes')">
            <span class="checkbox-label">{{theme.label}}</span>
          </label>
        </div>
        <div *ngIf="hasFieldError('themes')" class="field-error" id="themes-error" role="alert">
          <span *ngFor="let error of getFieldErrors('themes')" class="error-message">{{error}}</span>
        </div>
      </div>

      <!-- User Input -->
      <div class="form-group" [class.has-error]="hasFieldError('userInput')">
        <label for="userInput">Your Ideas (Optional):</label>
        <textarea
          id="userInput"
          [(ngModel)]="userInput"
          placeholder="Describe characters, settings, or plot elements you'd like to include..."
          rows="4"
          [attr.aria-describedby]="hasFieldError('userInput') ? 'userInput-error' : null"
          [attr.aria-invalid]="hasFieldError('userInput')"
          [disabled]="isGenerating || isGeneratingNext">
        </textarea>
        <div *ngIf="hasFieldError('userInput')" class="field-error" id="userInput-error" role="alert">
          <span *ngFor="let error of getFieldErrors('userInput')" class="error-message">{{error}}</span>
        </div>
      </div>

      <!-- Spicy Level Slider -->
      <div class="form-group" [class.has-error]="hasFieldError('spicyLevel')">
        <label for="spicyLevel">Spicy Level: {{spicyLevelLabels[spicyLevel - 1]}}</label>
        <div class="slider-container">
          <input
            type="range"
            id="spicyLevel"
            min="1"
            max="5"
            [(ngModel)]="spicyLevel"
            class="spicy-slider"
            [attr.aria-describedby]="hasFieldError('spicyLevel') ? 'spicyLevel-error' : null"
            [attr.aria-invalid]="hasFieldError('spicyLevel')"
            [disabled]="isGenerating || isGeneratingNext">
          <div class="slider-labels">
            <span>Mild</span>
            <span>Warm</span>
            <span>Hot</span>
            <span>Spicy</span>
            <span>Fire üî•</span>
          </div>
        </div>
        <div *ngIf="hasFieldError('spicyLevel')" class="field-error" id="spicyLevel-error" role="alert">
          <span *ngFor="let error of getFieldErrors('spicyLevel')" class="error-message">{{error}}</span>
        </div>
      </div>

      <!-- Word Count Dropdown -->
      <div class="form-group" [class.has-error]="hasFieldError('wordCount')">
        <label for="wordCount">Word Count:</label>
        <select 
          id="wordCount" 
          [(ngModel)]="wordCount"
          [attr.aria-describedby]="hasFieldError('wordCount') ? 'wordCount-error' : null"
          [attr.aria-invalid]="hasFieldError('wordCount')"
          [disabled]="isGenerating || isGeneratingNext">
          <option *ngFor="let option of wordCountOptions" [value]="option.value">
            {{option.label}}
          </option>
        </select>
        <div *ngIf="hasFieldError('wordCount')" class="field-error" id="wordCount-error" role="alert">
          <span *ngFor="let error of getFieldErrors('wordCount')" class="error-message">{{error}}</span>
        </div>
      </div>

      <!-- Generate Button -->
      <button
        class="generate-btn"
        (click)="generateStory()"
        [disabled]="isGenerating || !isFormValid()"
        [attr.aria-describedby]="isGenerating ? 'generating-status' : null"
        type="button">
        <span *ngIf="!isGenerating">‚ú® Generate Story</span>
        <span *ngIf="isGenerating" class="loading" id="generating-status" aria-live="polite">
          <span class="spinner" aria-hidden="true"></span>
          Crafting your tale...
        </span>
      </button>
      
      <!-- Form validation summary -->
      <div *ngIf="showValidationErrors && !isFormValid()" class="form-validation-summary" role="alert">
        <p class="validation-title">Please fix the following issues:</p>
        <ul>
          <li *ngFor="let error of formValidation().overall.errors">{{error}}</li>
        </ul>
      </div>
    </div>

    <!-- Story Display -->
    <div class="story-section" *ngIf="currentStory">
      <div class="story-header">
        <h2>Your Spicy {{getCreatureName()}} Story</h2>
        <div class="story-actions">
          <button
            class="action-btn audio-btn"
            (click)="convertToAudio()"
            [disabled]="isConvertingAudio || isSaving"
            [attr.aria-describedby]="isConvertingAudio ? 'audio-status' : null"
            type="button">
            <span *ngIf="!isConvertingAudio">üîä Convert to Audio</span>
            <span *ngIf="isConvertingAudio" class="loading" id="audio-status" aria-live="polite">
              <span class="spinner" aria-hidden="true"></span>
              Converting...
            </span>
          </button>

          <button
            class="action-btn save-btn"
            (click)="saveStory()"
            [disabled]="isSaving || isConvertingAudio"
            [attr.aria-describedby]="isSaving ? 'save-status' : null"
            type="button">
            <span *ngIf="!isSaving">üíæ Save Story</span>
            <span *ngIf="isSaving" class="loading" id="save-status" aria-live="polite">
              <span class="spinner" aria-hidden="true"></span>
              Saving...
            </span>
          </button>
        </div>
      </div>

      <div class="story-content" [innerHTML]="currentStory" [attr.aria-label]="'Generated story content'"></div>

      <div class="story-footer">
        <button
          class="continue-btn"
          (click)="generateNextChapter()"
          [disabled]="isGeneratingNext || isGenerating"
          [attr.aria-describedby]="isGeneratingNext ? 'continue-status' : null"
          type="button">
          <span *ngIf="!isGeneratingNext">üìñ Generate Next Chapter</span>
          <span *ngIf="isGeneratingNext" class="loading" id="continue-status" aria-live="polite">
            <span class="spinner" aria-hidden="true"></span>
            Writing next chapter...
          </span>
        </button>
      </div>
    </div>

    <!-- Audio Progress -->
    <div class="audio-progress" *ngIf="audioProgress > 0" role="status" aria-live="polite">
      <h3>Audio Conversion Progress</h3>
      <div class="progress-bar" [attr.aria-label]="'Audio conversion ' + audioProgress + '% complete'">
        <div class="progress-fill" [style.width.%]="audioProgress"></div>
      </div>
      <p>{{audioProgress}}% complete</p>
    </div>
  </div>
</div>


