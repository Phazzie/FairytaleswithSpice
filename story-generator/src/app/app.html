<div class="story-generator">
  <header class="header">
    <h1>🧚‍♀️ Fairytales with Spice</h1>
    <p>Create spicy fantasy stories with your favorite creatures</p>
  </header>

  <div class="main-content">
    <!-- Left Column: Story Generation Form -->
    <div class="form-section" ngSkipHydration>
      <h2>Story Configuration</h2>

      <!-- Creature Selector -->
      <div class="form-group">
        <label>Choose Your Creature:</label>
        <div class="radio-group">
          <label class="radio-option" *ngFor="let creature of creatures; trackBy: trackByCreature">
            <input type="radio" name="creature" [value]="creature.value" [(ngModel)]="selectedCreature">
            <span class="radio-label">{{creature.label}}</span>
          </label>
        </div>
      </div>

      <!-- Theme Checkboxes -->
      <div class="form-group">
        <label>Story Themes ({{getSelectedThemesCount()}}/5 selected):</label>
        <div class="checkbox-group">
          <label class="checkbox-option"
                 *ngFor="let theme of themes; trackBy: trackByTheme"
                 [class.selected]="isThemeSelected(theme.value)"
                 [class.disabled]="!canSelectMoreThemes() && !isThemeSelected(theme.value)">
            <input type="checkbox"
                   [checked]="isThemeSelected(theme.value)"
                   [disabled]="!canSelectMoreThemes() && !isThemeSelected(theme.value)"
                   (change)="toggleTheme(theme.value)">
            <span class="checkbox-label">{{theme.label}}</span>
          </label>
        </div>
      </div>

      <!-- User Input -->
      <div class="form-group">
        <label for="userInput">Your Ideas (Optional):</label>
        <textarea
          id="userInput"
          [(ngModel)]="userInput"
          placeholder="Describe characters, settings, or plot elements you'd like to include..."
          rows="4">
        </textarea>
      </div>

      <!-- Spicy Level Slider -->
      <div class="form-group">
        <label>Spicy Level: {{spicyLevelLabels[spicyLevel - 1]}}</label>
        <div class="slider-container">
          <input
            type="range"
            min="1"
            max="5"
            [(ngModel)]="spicyLevel"
            class="spicy-slider">
          <div class="slider-labels">
            <span>Mild</span>
            <span>Warm</span>
            <span>Hot</span>
            <span>Spicy</span>
            <span>Fire 🔥</span>
          </div>
        </div>
      </div>

      <!-- Word Count Dropdown -->
      <div class="form-group">
        <label for="wordCount">Word Count:</label>
        <select id="wordCount" [(ngModel)]="wordCount">
          <option *ngFor="let option of wordCountOptions" [value]="option.value">
            {{option.label}}
          </option>
        </select>
      </div>

      <!-- Generate Button -->
      <button
        class="generate-btn"
        (click)="generateStory()"
        [disabled]="isGenerating || !canGenerateStory()">
        <span *ngIf="!isGenerating && canGenerateStory()">✨ Generate Story</span>
        <span *ngIf="!isGenerating && !canGenerateStory()">❌ Select at least one theme</span>
        <span *ngIf="isGenerating" class="loading">
          <span class="spinner"></span>
          {{ generationStatus || 'Crafting your tale...' }}
        </span>
      </button>

      <!-- Story Generation Progress -->
      <div class="generation-progress" *ngIf="isGenerating && generationProgress > 0">
        <div class="progress-label">{{ generationStatus }}</div>
        <div class="progress-bar">
          <div class="progress-fill" [style.width.%]="generationProgress"></div>
        </div>
        <div class="progress-percentage">{{ generationProgress }}%</div>
      </div>
    </div>

    <!-- Right Column: Story Display -->
    <div class="story-column">
      <!-- Story Display -->
      <div class="story-section" *ngIf="currentStory">
        <div class="story-header">
          <h2>Your Spicy {{getCreatureName()}} Story</h2>
          <div class="story-actions">
            <button
              class="action-btn audio-btn"
              (click)="convertToAudio()"
              [disabled]="isConvertingAudio">
              <span *ngIf="!isConvertingAudio">🔊 Convert to Audio</span>
              <span *ngIf="isConvertingAudio" class="loading">
                <span class="spinner"></span>
                Converting...
              </span>
            </button>

            <button
              class="action-btn save-btn"
              (click)="saveStory()"
              [disabled]="isSaving">
              <span *ngIf="!isSaving">💾 Save Story</span>
              <span *ngIf="isSaving" class="loading">
                <span class="spinner"></span>
                Saving...
              </span>
            </button>
          </div>
        </div>

        <div class="story-content" [innerHTML]="currentStory"></div>

        <div class="story-footer">
          <button
            class="continue-btn"
            (click)="generateNextChapter()"
            [disabled]="isGeneratingNext">
            <span *ngIf="!isGeneratingNext">📖 Generate Next Chapter</span>
            <span *ngIf="isGeneratingNext" class="loading">
              <span class="spinner"></span>
              Writing next chapter...
            </span>
          </button>
        </div>
      </div>

      <!-- Placeholder when no story -->
      <div class="story-placeholder" *ngIf="!currentStory">
        <div class="placeholder-content">
          <h2>Your Story Will Appear Here</h2>
          <p>Configure your story settings on the left and click "Generate Story" to begin!</p>
          <div class="placeholder-icon">📚✨</div>
        </div>
      </div>

      <!-- Audio Progress -->
      <div class="audio-progress" *ngIf="audioProgress > 0">
        <h3>Audio Conversion Progress</h3>
        <div class="progress-bar">
          <div class="progress-fill" [style.width.%]="audioProgress"></div>
        </div>
        <p>{{audioProgress}}% complete</p>
      </div>

      <!-- Success Messages -->
      <div class="success-message" *ngIf="saveSuccess">
        ✅ Story saved successfully!
      </div>

      <div class="success-message" *ngIf="audioSuccess">
        🎵 Audio conversion completed! Use the player below to listen.
      </div>
      
      <!-- Enhanced Audio Player -->
      <div class="enhanced-audio-player" *ngIf="currentAudioUrl">
        <h3>🎧 Audio Narration</h3>
        
        <!-- Speaker Indicator -->
        <div class="speaker-indicator" *ngIf="currentSpeaker">
          <span class="speaker-icon">🎭</span>
          <span class="speaker-name">{{ currentSpeaker }}</span>
          <span class="voice-type">(Narrator)</span>
        </div>

        <!-- Progress Bar -->
        <div class="audio-progress-bar">
          <div class="progress-background">
            <div class="progress-fill" [style.width.%]="getProgressPercentage()"></div>
            <input 
              type="range" 
              class="seek-slider"
              [value]="currentTime" 
              [max]="currentAudioDuration" 
              step="0.1"
              (input)="seekTo(+$event.target.value)"
              />
          </div>
          <div class="time-display">
            <span class="current-time">{{ formatTime(currentTime) }}</span>
            <span class="separator"> / </span>
            <span class="total-time">{{ formatTime(currentAudioDuration) }}</span>
          </div>
        </div>

        <!-- Main Controls -->
        <div class="audio-controls-main">
          <button 
            class="control-btn rewind-btn" 
            (click)="rewind()"
            title="Rewind 10s (←)">
            ⏪
          </button>
          
          <button 
            class="control-btn play-pause-btn" 
            (click)="togglePlayback()"
            title="Play/Pause (Space)">
            {{ isPlaying ? '⏸️' : '▶️' }}
          </button>
          
          <button 
            class="control-btn forward-btn" 
            (click)="fastForward()"
            title="Forward 10s (→)">
            ⏩
          </button>
        </div>

        <!-- Advanced Controls -->
        <div class="audio-controls-advanced">
          <!-- Speed Control -->
          <div class="control-group">
            <label for="speed-control">Speed:</label>
            <select 
              id="speed-control"
              class="speed-selector"
              [(ngModel)]="playbackSpeed" 
              (change)="setPlaybackSpeed(playbackSpeed)">
              <option *ngFor="let speed of playbackSpeeds" [value]="speed.value">
                {{ speed.label }}
              </option>
            </select>
          </div>

          <!-- Volume Control -->
          <div class="control-group">
            <label for="volume-control">🔊</label>
            <input 
              id="volume-control"
              type="range" 
              class="volume-slider"
              min="0" 
              max="100" 
              step="1"
              [(ngModel)]="volume"
              (input)="setVolume(volume)"
              title="Volume (↑/↓)">
            <span class="volume-display">{{ volume }}%</span>
          </div>

          <!-- Download Button -->
          <a [href]="currentAudioUrl" download class="download-btn">
            💾 Download
          </a>
        </div>

        <!-- Hidden HTML5 Audio Element -->
        <audio 
          [src]="currentAudioUrl" 
          preload="metadata"
          style="display: none;">
          Your browser does not support the audio element.
        </audio>

        <!-- Keyboard Shortcuts Help -->
        <div class="keyboard-shortcuts">
          <small>
            🎹 <strong>Shortcuts:</strong> Space=Play/Pause, ←/→=Seek, ↑/↓=Volume
          </small>
        </div>
      </div>
    </div>
  </div>

  <!-- Error Display Component -->
  <app-error-display></app-error-display>
</div>

<!-- Debug Panel Component -->
<app-debug-panel #debugPanel></app-debug-panel>


